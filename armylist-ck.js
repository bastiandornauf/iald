function updatePage(){var e=document;e.getElementById("armylist").innerHTML=updateArmyList();hideUnitWpn(storageGet("displayWeapons",!0));hideLoadbox(storageGet("displayEdit",!1))}function registerEvents(){$("button").click(performClick);$("#wbtn").click(tglWeapons);$("#lbtn").click(performLoadClick)}function performClick(){var e=!0,t=$(this).attr("id");if(t=="import"){armylistContent=importArmy();storageSet("army",armylistContent);e=!0}else if(t=="importLink"){var n=document.getElementById("armyImport").value;importArmyFromLink(n)}else if(t=="reset"){if(confirm("This will replace your army list with an example.\nAre you sure?")){armylistContent=dumpArmyAsText();storageSet("army",armylistContent);e=!0}}else if(t=="download")onDownload();else if(t=="export")exportCurrentArmy();else{if(t=="help")return;var r=parseInt(t.substring(4));units.length>0&&(units[r].alive=!units[r].alive);storageSet("army",units)}updatePage(e);registerEvents()}function performLoadClick(){display=!storageGet("displayEdit",!1);storageSet("displayEdit",display);if(!display){armylistContent=JSON.parse(document.getElementById("armyImport").value);storageSet("army",armylistContent);updatePage(!0)}else updatePage(!1);registerEvents()}function hideUnitWpn(e){var t=document;if(e){$(".weapondata").show();t.getElementById("wbtn").innerHTML="hide wpn"}else{$(".weapondata").hide();t.getElementById("wbtn").innerHTML="show wpn"}var n=t.getElementsByClassName("unitWpn");for(var r=0;r<n.length;r++)n[r].hidden=e}function hideLoadbox(e){var t=document;if(e){$("#loadbox").show();t.getElementById("lbtn").innerHTML="update army"}else{$("#loadbox").hide();t.getElementById("lbtn").innerHTML="edit army"}}function tglWeapons(){display=!storageGet("displayWeapons",!0);storageSet("displayWeapons",display);hideUnitWpn(display)}function loadUnits(){return armylistContent}function updateArmyList(){var e={activePts:0,pts:0,swc:0,units:0,activeUnits:0},t=new Array;units=loadUnits();for(var n=0;n<units.length;n++)t.push(htmlUnit(units[n],e,n));return htmlListOpen(e)+t.join(" ")+"</ul>"}function htmlListOpen(e){var t=e.pts*.4,n=e.activeUnits+"/"+e.units+" models, "+e.activePts+"/"+e.pts+"pts, "+e.swc+"SWC &mdash; break at "+Math.floor(t);e.activePts<=0?n="<span class='red'>ANNIHILATED! "+n+"</span>":e.activePts<=t&&(n="<span class='red'>RETREAT! "+n+"</span>");return'<div class="top"><span class="clear" id="lbtn" title="open army editor">edit army</span><span class="clear" id="wbtn" title="toggle verbose weapon display">hide wpns</span><a href="help.html" class="imgLink" title="open help page"><button id="help">help</button></a><div class="screen">'+n+"</div></div>"+'<div id="loadbox">Enter the army list here - either as Export from iaAleph or as manually entered JSON. If you enter invalid JSON your changes will get lost (click several time on updateArmy-button until it works again ;) See the help page for more infos about editing.<br>The reset-button loads a default army list - be careful, there is no safety question. Download allows you to save the army data as text file.<br>'+'<br>I have finished a way to import army lists from <a href="http://anyplace.it/ia/">ia Aleph</a>.'+" Copy-paste the link from the aleph export window and click FROM LINK or copy the list that is shown when you click export in aleph then paste the list into the army editor field here and click IMPORT. Voila. I hope it works fine!<br><br>"+'<textarea id="armyImport" rows="10" cols="60">'+JSON.stringify(armylistContent,null,"	")+"</textarea><br>"+'<button id="import" title="imports an army">import</button>'+'<button id="importLink" title="imports an army from a link">from link</button>'+'<button id="reset" title="reset army to example">reset</button>'+'<button id="export" title="export">export</button>'+'</div><ul data-role="listview" data-inset="true" data-filter="true">'}function htmlUnit(e,t,n){if(e==undefined){alert("Unit was null - a bug has happened. I reset the army list, sorry!");armylistContent=JSON.parse(dumpArmyAsText());storageSet("army",armylistContent);return""}if(typeof e=="string")return"<h1>"+e+"</h1>";name=e.spec;type=e.type;pts=parseInt(e.pts);swc=parseInt(e.swc);mov=e.mov;cc=e.cc;bs=e.bs;ph=e.ph;wip=e.wip;arm=e.arm;bts=e.bts;w=e.w;"props"in e?props=e.props.split(","):props=[];"weapons"in e?weapons=e.weapons.split(","):weapons=[];active=e.alive;e.regular?icons="<a href = 'http://infinitythegame.wikispot.org/Instruction?action=show' class='imgLink'><img src='http://www.bastian-dornauf.de/iald/icons/regular_icon.png' width='24px' height='24px'></a>":icons="<a href = 'http://infinitythegame.wikispot.org/Instruction?action=show' class='imgLink'><img src='http://www.bastian-dornauf.de/iald/icons/irregular_icon.png' width='24px' height='24px'></a>";e.impetuous&&(icons+=" <a href = 'http://infinitythegame.wikispot.org/Fury?action=show' class='imgLink'><img src='http://www.bastian-dornauf.de/iald/icons/impetuous_icon.png' width='24px' height='24px'></a> ");if(active){t.activePts+=pts;t.activeUnits++}t.pts+=pts;t.swc+=swc;t.units++;var r="";active?r+='<div class="active" id="act'+n+'">':r+='<div class="inactive" id="act'+n+'">';r+='<div class="unit"><div class="unitName">';button='<button title="toggle status of this unit" id="unit'+n+'">'+t.units+"</button>";r+='<div class="unitCost">'+type+" "+pts+"pts "+swc+"SWC</div>"+button+name;if(active){r+="</div>";"header"in e&&(r+="<h2>"+e.header+"</h2>");r+=statBox(mov,cc,bs,ph,wip,arm,bts,w,1);if("secondStatLine"in e){r+="<h2 class='second'>"+e.secondStatLine.header+"</h2>";r+=statBox(e.secondStatLine.mov,e.secondStatLine.cc,e.secondStatLine.bs,e.secondStatLine.ph,e.secondStatLine.wip,e.secondStatLine.arm,e.secondStatLine.bts,e.secondStatLine.w,.5)}propLinks=new Array;for(var n=0;n<props.length;n++)props[n].trim()!=""&&propLinks.push('<a href="http://infinitythegame.wikispot.org/'+props[n].trim()+'">'+props[n]+"</a>");r+='<div class="unitProps">'+icons+" "+propLinks.join(" ")+"</div>";wpnLinks=new Array;for(var n=0;n<weapons.length;n++)weapons[n].trim()!==""&&wpnLinks.push('<a href="http://infinitythegame.wikispot.org/'+weapons[n].replace(/ *\([^)]*\) */g,"").trim()+'">'+weapons[n]+"</a>");r+='<div class="unitWpn">'+wpnLinks.join(" ")+"</div>";r+='<table class="weapondata"><tr><th>Weapon</th><th>Dmg</th><th>B</th><th>Ammo</th><th>Template</th><th class="value">S</th><th class="value">M</th><th class="value">L</th><th class="value">Max</th><th>Notes</th></tr>';for(var n=0;n<weapons.length;n++){weaponName=weapons[n];weaponName.trim()!=""&&(r+="<tr><td>"+wpnLinks[n]+"</td>"+htmlWeapon(weaponName)+"</tr>")}r+="</table>"}else r+=" &mdash; Out Of Action! </div> ";r+="</div>";r+="</div>\n\n";return r}function statBox(e,t,n,r,i,s,o,u,a){var f="";f+="<table style='opacity:"+a+";"+"'><tr>";f+="<th class='isc'>mov</th>";f+="<th class='isc'>cc</th>";f+="<th class='isc'>bs</th>";f+="<th class='isc'>ph</th>";f+="<th class='isc'>wip</th>";f+="<th class='isc'>arm</th>";f+="<th class='isc'>bts</th>";f+="<th class='isc'>w</th>";f+="</tr>";f+="<tr>";f+='<td class="stats">'+e+"</td>";f+='<td class="stats">'+t+"</td>";f+='<td class="stats">'+n+"</td>";f+='<td class="stats">'+r+"</td>";f+='<td class="stats">'+i+"</td>";f+='<td class="stats">'+s+"</td>";f+='<td class="stats">'+fmt(bts)+"</td>";f+='<td class="stats">'+u+"</td>";f+="</tr></table>";return f}function htmlWeapon(e){sname=e.replace(/ *\([^)]*\) */g,"").trim();var t=$.grep(data_weapons,function(e){return e.name.trim().toLowerCase()==sname.trim().toLowerCase()});if(t.length==0)return"<td colspan='9'>weapon data not found.</td>";if(t.length==1){weapon=t[0];var n="";n+="<td class='wpnStats'>"+optOP(weapon.damage)+"</td>";n+="<td class='wpnStats'>"+optOP(weapon.burst)+"</td>";if(weapon.ammo.indexOf("/")===-1&&weapon.ammo.indexOf("+")===-1)n+="<td class='wpnStatsS'><a href='http://infinitythegame.wikispot.org/"+weapon.ammo+"''>"+weapon.ammo+"</a></td>";else{if(weapon.ammo.indexOf("/")!==-1){ammos=weapon.ammo.split("/");n+="<td class='wpnStatsS'>";for(var r=0;r<ammos.length;r++){n+="<a href='http://infinitythegame.wikispot.org/"+ammos[r]+"''>"+ammos[r]+"</a>";r<ammos.length-1&&(n+="/")}}else{ammos=weapon.ammo.split("+");n+="<td class='wpnStatsS'>";for(var r=0;r<ammos.length;r++){n+="<a href='http://infinitythegame.wikispot.org/"+ammos[r]+"''>"+ammos[r]+"</a>";r<ammos.length-1&&(n+="+")}}n+="</td>"}n+="<td class='wpnStatsS'>"+weapon.template+"</td>";n+="<td class='wpnStats' "+tdCol(weapon.short_mod)+">"+slash(weapon.short_dist,weapon.short_mod)+"</td>";n+="<td class='wpnStats' "+tdCol(weapon.medium_mod)+">"+slash(weapon.medium_dist,weapon.medium_mod)+"</td>";n+="<td class='wpnStats' "+tdCol(weapon.long_mod)+">"+slash(weapon.long_dist,weapon.long_mod)+"</td>";n+="<td class='wpnStats' "+tdCol(weapon.max_mod)+">"+slash(weapon.max_dist,weapon.max_mod)+"</td>";var i=new Array;weapon.em_vul=="Yes"&&i.push("E/M vuln.");weapon.cc=="Yes"&&i.push("in CC");weapon.note!=""&&i.push(weapon.note);n+="<td>"+i.toString()+"</td>";return n}console.log("multiple weapons found: %o",t)}function slash(e,t){e=optOP(e);t=fmt(t);return e=="-"&&t==="-"?"&ndash;":e+"/"+t}function tdCol(e){if(e>=3)return"style='background-color:#6c3'";if(e>-3&&e<3)return"style='background-color:#ff6;'";if(e<=-3&&e>-6)return"style='background-color:#f93;'";if(e<=-6)return"style='background-color:#f33;'"}function fmt(e){return e>0?"+"+e:e<0?"&minus;"+Math.abs(e):optOP(e)}function optOP(e){e=="--"&&(e="&ndash;");return e}function dumpArmyAsText(){var e='[\r\n  "triad 1",\r\n  {\r\n    "spec": "Sakiel - Viral",\r\n    "header": "active symbiont armor",\r\n    "regular": true,\r\n    "impetuous": true,\r\n    "type": "LI",\r\n    "pts": 26,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 14,\r\n    "bs": 12,\r\n    "ph": 11,\r\n    "wip": 13,\r\n    "arm": 2,\r\n    "bts": 0,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa, Impetuous, Symbiont Armour, V: Courage",\r\n    "weapons": "Viral Combi Rifle, Swarm Grenades, Pistol, Knife",\r\n    "secondStatLine": {\r\n      "header": "inactive symbiont armor",\r\n      "mov": "4-4",\r\n      "bs": 12,\r\n      "cc": 14,\r\n      "ph": 11,\r\n      "wip": 13,\r\n      "arm": 0,\r\n      "bts": 0,\r\n      "w": 1\r\n    },\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Kamael - Combi",\r\n    "regular": true,\r\n    "impetuous": false,\r\n    "type": "LI",\r\n    "pts": 12,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 13,\r\n    "bs": 11,\r\n    "ph": 11,\r\n    "wip": 13,\r\n    "arm": 1,\r\n    "bts": 0,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa",\r\n    "weapons": "Combi Rifle, Pistol, Knife",\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Kamael - Combi",\r\n    "regular": true,\r\n    "impetuous": false,\r\n    "type": "LI",\r\n    "pts": 12,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "bs": 13,\r\n    "cc": 11,\r\n    "ph": 11,\r\n    "wip": 13,\r\n    "arm": 1,\r\n    "bts": 0,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa",\r\n    "weapons": "Combi Rifle, Pistol, Knife",\r\n    "alive": true\r\n  },\r\n  "triad 2",\r\n  {\r\n    "spec": "Makaul - Swarm",\r\n    "regular": true,\r\n    "impetuous": true,\r\n    "type": "WB",\r\n    "pts": 18,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 19,\r\n    "bs": 11,\r\n    "ph": 13,\r\n    "wip": 13,\r\n    "arm": 1,\r\n    "bts": -3,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa, Impetuous, Martial Arts L2, i-Kohl L1",\r\n    "weapons": "Swarm Grenades, Zero-V Smoke Grenades, Heavy Flamethrower, Pistol, Viral CCW",\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Makaul - Flamer",\r\n    "regular": true,\r\n    "impetuous": true,\r\n    "type": "WB",\r\n    "pts": 15,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 19,\r\n    "bs": 11,\r\n    "ph": 13,\r\n    "wip": 13,\r\n    "arm": 1,\r\n    "bts": -3,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa, Impetuous, Martial Arts L2, i-Kohl L1",\r\n    "weapons": "Zero-V Smoke Grenades, Heavy Flamethrower, Pistol, Viral CCW",\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Makaul - Flamer",\r\n    "regular": true,\r\n    "impetuous": true,\r\n    "type": "WB",\r\n    "pts": 15,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 19,\r\n    "bs": 11,\r\n    "ph": 13,\r\n    "wip": 13,\r\n    "arm": 1,\r\n    "bts": -3,\r\n    "w": 1,\r\n    "props": "Cube, Fireteam: Tohaa, Impetuous, Martial Arts L2, i-Kohl L1",\r\n    "weapons": "Zero-V Smoke Grenades, Heavy Flamethrower, Pistol, Viral CCW",\r\n    "alive": true\r\n  },\r\n  "loner",\r\n  {\r\n    "spec": "Ectros - Lt",\r\n    "header": "active symbiont armor",\r\n    "regular": true,\r\n    "impetuous": false,\r\n    "type": "HI",\r\n    "pts": 50,\r\n    "swc": 0,\r\n    "mov": "4-4",\r\n    "cc": 17,\r\n    "bs": 13,\r\n    "ph": 14,\r\n    "wip": 13,\r\n    "arm": 3,\r\n    "bts": -6,\r\n    "w": 2,\r\n    "props": "Cube, Fireteam: Tohaa, Poison, Symbiont Armor",\r\n    "weapons": "Viral Combi Rifle, Nanopulser, Pistol, CCW",\r\n    "secondStatLine": {\r\n      "header": "inactive symbiont armor",\r\n      "mov": "4-4",\r\n      "cc": 17,\r\n      "bs": 12,\r\n      "ph": 11,\r\n      "wip": 13,\r\n      "arm": 0,\r\n      "bts": 0,\r\n      "w": 1\r\n    },\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Chaksa - HMG",\r\n    "regular": true,\r\n    "impetuous": false,\r\n    "type": "LI",\r\n    "pts": 25,\r\n    "swc": 1,\r\n    "mov": "4-4",\r\n    "cc": 14,\r\n    "bs": 11,\r\n    "ph": 12,\r\n    "wip": 13,\r\n    "arm": 0,\r\n    "bts": 0,\r\n    "w": 1,\r\n    "props": "Poison, V: Courage, 360° Visor, Neurocinetics",\r\n    "weapons": "HMG, Pistol, CCW",\r\n    "alive": true\r\n  },\r\n  {\r\n    "spec": "Chaksa - HMG",\r\n    "regular": true,\r\n    "impetuous": false,\r\n    "type": "LI",\r\n    "pts": 25,\r\n    "swc": 1,\r\n    "mov": "4-4",\r\n    "cc": 14,\r\n    "bs": 11,\r\n    "ph": 12,\r\n    "wip": 13,\r\n    "arm": 0,\r\n    "bts": 0,\r\n    "w": 1,\r\n    "props": "Poison, V: Courage, 360° Visor, Neurocinetics",\r\n    "weapons": "HMG, Pistol, CCW",\r\n    "alive": true\r\n  }\r\n]';return JSON.parse(e)}function importArmy(){var e=document.getElementById("armyImport").value,t=e.split("\n"),n=new Array;for(var r=0;r<t.length;r++){var i=t[r].replace(/ *\([^)]*\) */g,"").trim();if(i!="")if(i.indexOf("Combat Group")!==-1)n.push(i);else{var s=findUnitBySpec(i);s!==null?n.push(s):n.push(i)}}return n}function findUnitBySpec(e){var t=getUnitsJSON();index=searchArray("spec",e,t);return index>=0?t[index]:null}function importArmyFromAleph(e){var t=getJSONfromURL(e).models,n=new Array;for(var r=0;r<t.length;r++){var i=t[r],s=findUnitByISCAndCode(i.isc,i.code);s!==null?n.push(s):n.push("unit not found:"+i.toString())}return n}function findUnitByISCAndCode(e,t){var n=getUnitsJSON();for(var r=0;r<n.length;r++)if(n[r].isc===e&&n[r].code===t)return n[r];console.log("unit not found: "+e+"/"+t);return null}function decode_base64(e){return atob(e)}function getJSONfromURL(e){var t=e.replace(/^.*list=/,"");t=decodeURI(t);t=t.replace(/[%]../g,"").replace(/_/g,"/").replace(/-/g,"+").replace(/[.:]/g,"=").replace(/[^a-zA-Z0-9+\/=]/g,"");t=decode_base64(t);var n=!0;try{var r=$.parseJSON(t)}catch(i){alert("Error while reading JSON from URL: "+i+"\n\n"+e+"\n\n"+t);n=!1}return n?r:null}function searchArray(e,t,n,r){if(typeof n=="undefined"||!n.length)return-1;var i=n.length-1,s=0;r=typeof r=="undefined"||r?!0:!1;t=r?t.toLowerCase():t;while(s<=i){mid=parseInt((s+i)/2);element=r?n[mid][e].toLowerCase():n[mid][e];if(element>t)i=mid-1;else{if(!(element<t))return mid;s=mid+1}}return-1}function html5StorageSupported(){return"localStorage"in window&&window.localStorage!==null}function storageGet(e,t){var n=localStorage.getItem("iald."+e),r=!0;try{var i=$.parseJSON(n)}catch(s){r=!1}if(r)return i;alert("An error might have happened.\nData from storage = "+n+"\nuse default instead = "+t);return t}function storageSet(e,t){return localStorage.setItem("iald."+e,JSON.stringify(t))}function gotGooglResponse(e){importArmyFromLink(e.longUrl)}function importArmyFromLink(e){if(e.indexOf("goo.gl")!==-1)$.ajax({url:"https://www.googleapis.com/urlshortener/v1/url",data:{key:"AIzaSyC_cFnn6Ync9iMl8njqsvmhDSlfkTzqjlY",shortUrl:e},success:gotGooglResponse});else{if(e.indexOf("anyplace.it")===-1){alert("no valid link found");return null}result=importArmyFromAleph(e);armylistContent=result;storageSet("army",armylistContent);rebuild=!0;updatePage(rebuild);registerEvents()}}function getUrlVars(e){var t=[],n,r=e.slice(e.indexOf("?")+1).split("&");for(var i=0;i<r.length;i++){n=r[i].split("=");t.push(n[0]);t[n[0]]=n[1]}return t}function copyToClipboard(e){window.prompt("This link loads IALD and imports the current army.\nTo copy to clipboard press: Ctrl+C, Enter",encodeURI(e))}function displayInNewWindow(e){copyToClipboard(e)}function exportCurrentArmy(){var e=shortenArmyList(getArmy());link=window.location+"?import=iald&list="+encodeBU(JSON.stringify(e,null,""));displayInNewWindow(link)}function encodeBU(e){return btoa(encode_utf8(e))}function decodeBU(e){return decode_utf8(atob(e))}function encode_utf8(e){return unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function getArmy(){return armylistContent==null||typeof armylistContent!="array"?JSON.parse(document.getElementById("armyImport").value):armylistContent}function shortenArmyList(e){var t=new Array;for(var n=0;n<e.length;n++){var r=e[n];if(typeof r=="object"){if(r!=null)if(findUnitBySpec(r.spec)!=null){var i=new Object;i.importThis=r.spec;t.push(i)}else t.push(r)}else t.push(r)}return t}function importArmyFromIALD(e){var t=e,n=new Array;for(var r=0;r<t.length;r++){var i=t[r];if(i!=null&&typeof i=="object")if("importThis"in i){var s=findUnitBySpec(i.importThis);s!==null?n.push(s):n.push("unit not found:"+i.toString())}else n.push(i);else i!=null&&n.push(i)}return n}var units=new Array;$(document).ready(function(){html5StorageSupported()||alert("Your browser does not support HTML5 webstorage.\nIALD will not work properly in this browser.\nSorry.");storageGet("displayWeapons",!0)===null&&storageSet("displayWeapons",!0);storageGet("displayEdit",!1)===null&&storageSet("displayEdit",!1);data=storageGet("army",null);data==null&&(data=dumpArmyAsText());armylistContent=data;var e=$.getUrlVars();if("list"in e&&confirm("An army list will be imported.\nThis will overwrite your current army list in IALD.\n\nAre you sure?"))if("import"in $.getUrlVars())if($.getUrlVar("import").toLowerCase()==="aleph"){armylistContent=importArmyFromAleph($.getUrlVar("list"));storageSet("army",armylistContent)}else if($.getUrlVar("import").toLowerCase()==="iald"){armylistContent=importArmyFromIALD(JSON.parse(decodeBU($.getUrlVar("list").replace(/\.\.\./g,""))));storageSet("army",armylistContent)}else alert("The URL contains a list but the import source is unknown.");else alert("The URL contains a list but the import source is not specified.");updatePage();registerEvents()});$.extend({getUrlVars:function(){var e=[],t,n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var r=0;r<n.length;r++){t=n[r].split("=");e.push(t[0]);e[t[0]]=t[1]}return e},getUrlVar:function(e){return $.getUrlVars()[e]}});